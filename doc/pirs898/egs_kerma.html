<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>EGSnrc C++ class library: egs_kerma: Kerma calculations in a volume</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<script language="JavaScript" type="text/javascript">
    $(document).ready(function(){
    var imgArr = new Array( // relative paths of images
    'linac2.png',
    'egs_isotropic_source.png',
    'egs_conestack.png',
    'car.png',
    'egs_cd_geometry.png',
    'chamber.png',
    'c_in_box.png',
    'egs_collimated_source.png',
    'egs_iplanes.png',
    'egs_point_source.png',
    'linac_s1.png',
    'egs_ndgeometry.png',
    'egs_roundrect_cylinders.png',
    'egs_source_collection.png',
    'egs_xyzrepeater.png',
    'cones.png',
    'egs_prism.png',
    'egs_pyramid.png',
    'I6702.png',
    'egs_xyzgeometry.png',
    'linac1.png'
    );
    var preloadArr = new Array();
    var i;
    /* preload images */
    for(i=0; i < imgArr.length; i++){
    preloadArr[i] = new Image();
    preloadArr[i].src = imgArr[i];
    }
    changeImg();
    var intID = setInterval(changeImg, 5000);
    /* image rotator */
    function changeImg(){
    $('#egsImageScroller').css('background','#000000 url(' + preloadArr[Math.floor(Math.random() * imgArr.length)].src +') center/contain no-repeat');
    }
    });
</script>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="egsImageScroller"></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">EGSnrc C++ class library
   &#160;<span id="projectnumber">Report PIRS-898 (2019)</span>
   </div>
   <div id="projectbrief">Iwan Kawrakow, Ernesto Mainegra-Hing, Frederic Tessier, Reid Townson and Blake Walters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Coding&#160;Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">egs_kerma: Kerma calculations in a volume </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_intro">Introduction</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_geometry">Geometries</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_sources">Particle source definition</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_options">Scoring options input block</a>  <ul>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_calculation">Kerma scoring</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_FD">Variance reduction: Forced Detection</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_fluence">Fluence scoring</a>  </li>
</ul>
</li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_output">Output</a>  </li>
<li>
<a class="el" href="common.html#common_mc">Monte Carlo transport parameters</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_usage">Usage</a>  </li>
<li>
<a class="el" href="egs_kerma.html#egs_kerma_example">An input example: Kerma in 5 cm air sphere for 40 keV</a>  </li>
</ul>
<h1><a class="anchor" id="egs_kerma_intro"></a>
Introduction</h1>
<p>The C++ application <code>egs_kerma</code> is an advanced EGSnrc application whose main goal is the estimation of kerma in a volume defined by one or more geometrical regions by means of a track-length estimator. The efficiency of the calculation can be increased by several orders of magnitude by using the variance reduction technique (VRT) known as <a class="el" href="egs_kerma.html#egs_kerma_FD">forced detection</a> (FD). It can also be used for estimating the total and differential photon fluence in the scoring volume.</p>
<p>This code is by no means in its final stage. It is still very experimental and it has been cleaned up for release in the hope it will be useful to EGSnrc users. A number of collaborators have been using it for some time and have helped with their comments and bug reporting.</p>
<h1><a class="anchor" id="egs_kerma_geometry"></a>
Geometries</h1>
<p>Geometries are specified in an input file as explained in the <a class="el" href="group__Geometry.html">geometry module</a>. Besides the simulation geometry, a geometry should be defined that encompasses all scoring regions to be able to take advantage of the <a class="el" href="egs_kerma.html#egs_kerma_FD">FD</a> VRT.</p>
<h1><a class="anchor" id="egs_kerma_sources"></a>
Particle source definition</h1>
<p>Any source from the <code>egs++</code> <a class="el" href="group__Sources.html">particle sources module</a> can be used. Here is an example for an isotropic point source of 40 keV photons placed at 100 cm on the negative z-axis:</p>
<pre class="fragment">:start source:
    name    = isotropic
    library = egs_isotropic_source
    charge  = 0

    ### source shape
    :start shape:
        type = point
        position = 0, 0, -100
    :stop shape:

    ### source spectrum
    :start spectrum:
        type = monoenergetic
        energy = 0.04  # MeV
    :stop spectrum:

:stop source:
</pre><p><b>BEWARE:</b> No check is made for the charge of the initial particles. Although kerma is only defined for neutral particles such as photons and neutrons, one could potentially want to calculate kerma for secondary neutral particles generated by charged particles.</p>
<h1><a class="anchor" id="egs_kerma_options"></a>
Scoring options input block</h1>
<p>Kerma in the scoring volume can be calculated for several geometries at once. Hence a correlated scoring of kerma ratios can be requested by linking any combination of two calculation geometries. In cases of small differences between these geometries, the kerma ratios will be strongly correlated, resulting in a significant reduction of the variance. Correlated scoring is requested by assigning two geometry names to the <b><code>correlated geometries</code></b> key. A pseudo input block of such an input is shown below:</p>
<pre class="fragment">:start scoring options:

    :start calculation geometry:
        geometry name  = name_1
        cavity regions = list_of_cavity_region_indices
        cavity mass    = total cavity mass in grams
        excluded regions = list_of_regions # exclude particles touching these regions
    :stop calculation geometry:
    :start calculation geometry:
        geometry name  = name_1
        cavity regions = list_of_cavity_region_indices
        cavity mass    = total cavity mass in grams
        excluded regions = list_of_regions
    :stop calculation geometry:
    :start calculation geometry:
        geometry name  = name_2
        ...
    :stop calculation geometry:
    ...
    :start calculation geometry:
        geometry name  = name_n
        ...
    :stop calculation geometry:

    correlated geometries = name_i name_j
    ...
    correlated geometries = name_k name_l

    ### fluence scoring requested (common to all calculation geometries)
    :start fluence scoring:
        minimum energy = Emin
        maximum energy = Emax
        number of bins = N
        scale          = linear # linear or logarithmic
    :stop fluence scoring:

    ### E*muen file (could also be E*mutr): absolute or relative file path
    emuen file = absolute_file_name

     ### geometry for forced-detection (if omitted, an analog scoring is used)
    cavity geometry = cavity # For forced detection

:stop scoring options:
</pre><p>The meaning of the various keys defining a calculation geometry should be self explanatory. The reason one must specify the cavity mass is that due to the generality of the geometry package it is not possible to automatically compute the cavity volume and therefore the user must supply this information for proper normalization. Geometrical regions spanning the scoring volume (cavity) are provided via the <b><code>cavity regions</code></b> key. If no valid region is entered or this input is ignored, no kerma to the cavity of the calculation geometry is calculated.</p>
<h1><a class="anchor" id="egs_kerma_calculation"></a>
Kerma scoring</h1>
<p>Kerma calculations require a file containing pairs of energy <img class="formulaInl" alt="$ E $" src="form_99.png"/> and <img class="formulaInl" alt="$ E \times \frac{\mu_{en}}{\rho} $" src="form_100.png"/> values for the medium of interest. This allows a faster evaluation of the summation over all contributing particles by saving the multiplication operation. The full name (absolute path) of this file <b>must</b> be provided using the <b><code>emuen file</code></b> key as shown in the above example.</p>
<p>Kerma for medium <img class="formulaInl" alt="$m$" src="form_101.png"/>, <img class="formulaInl" alt="$K_m$" src="form_102.png"/> is computed by summing up the individual contributions of N photons crossing the scoring volume <img class="formulaInl" alt="$V$" src="form_103.png"/> using the expression</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ K_m=\sum_{i=1}^{N} w_i \cdot \frac{l_i}{V} \cdot E_i \cdot \left(\frac{\mu_\mathrm{en}}{\rho}\right)_i^m \]" src="form_104.png"/>
</p>
<p>The example file <em>emuen_icru90_1.5MeV.data</em> contains <img class="formulaInl" alt="$ E \times \frac{\mu_{en}}{\rho} $" src="form_100.png"/> values for air on a logarithmic energy scale from 1 keV up to 1.5 MeV. These values were calculated with the <em>g</em> application using the following (non-default) transport parameters:</p>
<pre class="fragment">##############################
:start mc transport parameter:

 Global ECUT = 0.512
 Global PCUT = 0.001

 Photon cross sections = mcdf-xcom # XCOM with renormalized PE xsections
 Pair cross sections = nrc
 Triplet production = On
 Radiative Compton corrections = On

 Brems cross sections = nrc
 Electron Impact Ionization = penelope # Could be also ik

:stop mc transport parameter:
##############################</pre><p>This file is distributed with <em>egs_kerma</em> in the same folder.</p>
<h1><a class="anchor" id="egs_kerma_FD"></a>
Variance reduction: Forced Detection</h1>
<p>If the user provides the name of a defined geometry encompassing all scoring regions, then a variance reduction technique known as <em>forced detection</em> can be used which increases the calculation efficiency by about 3 orders of magnitude compared to an analog calculation. The name of such a geometry should be provided to the application via the key <b><code>cavity geometry</code></b> in the <b><code>scoring options</code></b> input block. If no such geometry is provided, kerma is calculated in an analog manner, <em>i.e</em>. by scoring every time a photon crosses the scoring volume.</p>
<p>The usual approach to compute kerma <img class="formulaInl" alt="$K_m$" src="form_102.png"/> for medium <img class="formulaInl" alt="$m$" src="form_101.png"/> is to score the individual contributions from photons crossing the scoring region. This approach is already several times more efficient than using the kerma approximation where a full simulation of all photon interactions is performed assuming electrons deposit their energy on the spot. One can go one step further and estimate the contribution to kerma from any photon that could potentially cross the scoring region due to its direction. An algorithm to determine whether the direction of the photon intercepts with the scoring region needs to be implemented, as well as a ray-tracing algorithm to account for the attenuation through the geometry. This way, one does not have to wait until the photon reaches the scoring region to estimate its contribution to the kerma and a more efficient sampling of all possible contributions is achieved. This approach is equivalent to running N separate MC simulations where in the <img class="formulaInl" alt="$ k^{th} $" src="form_105.png"/> simulation, only the contribution to the kerma from particles interacting <img class="formulaInl" alt="$k-1$" src="form_106.png"/> times is scored. After running all these simulations, they can be added together to obtain the total kerma.</p>
<p>Kerma to medium <img class="formulaInl" alt="$m$" src="form_101.png"/> is computed by adding up the contribution from all photons aimed at the <b><code>cavity geometry</code></b> using the expression</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ K_m=\sum_{i=1}^{N} w_i \cdot \frac{l_i}{V} \cdot E_i \cdot \left(\frac{\mu_\mathrm{en}}{\rho}\right)_i^m \cdot e^{- \sum_{j=1}^{N_j} \mu_{ij} \cdot l_{ij}} \]" src="form_107.png"/>
</p>
<p>with <img class="formulaInl" alt="$N_j$" src="form_108.png"/> the number of regions crossed by the <img class="formulaInl" alt="$ i^\mathrm{th}$" src="form_109.png"/> photon, <img class="formulaInl" alt="$\mu_{ij}$" src="form_110.png"/> the attenuation coefficient in region <img class="formulaInl" alt="$j$" src="form_11.png"/> and <img class="formulaInl" alt="$l_{ij}$" src="form_111.png"/> the path across region <img class="formulaInl" alt="$j$" src="form_11.png"/>.</p>
<h1><a class="anchor" id="egs_kerma_fluence"></a>
Fluence scoring</h1>
<p>A photon fluence calculation can be requested using the following input block:</p>
<pre class="fragment">:start scoring options:
    ...
    :start fluence scoring:
        minimum energy = Emin
        maximum energy = Emax
        number of bins = N
        scale          = linear, logarithmic
    :stop fluence scoring:
:stop scoring options:
</pre><p>Differential fluence <img class="formulaInl" alt="$ \phi_j $" src="form_31.png"/> is calculated by scoring the volume-averaged track length for particles with energies E between <img class="formulaInl" alt="$E_j$" src="form_32.png"/> and <img class="formulaInl" alt="$E_{j+1}$" src="form_33.png"/> using Chilton's fluence concept for any sampling volume V:</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \phi_j=\frac{\sum_{i=1}^{N_j} w_i \cdot l_i}{V} \]" src="form_112.png"/>
</p>
<p>where <img class="formulaInl" alt="$\displaystyle l_i$" src="form_35.png"/> is the length of the <img class="formulaInl" alt="$\displaystyle i^{th} $" src="form_36.png"/> particle track. The width of the energy bins is defined by <img class="formulaInl" alt="$ E_{min} $" src="form_37.png"/>, <img class="formulaInl" alt="$ E_{max} $" src="form_38.png"/> and the number of bins N. Total fluence <img class="formulaInl" alt="$ \Phi $" src="form_39.png"/> is calculated as the sum over all contributions to the fluence</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \Phi=\sum_{j=0}^{N-1} \phi_j \]" src="form_40.png"/>
</p>
<p>The <b><code>fluence scoring</code></b> input block can be used to request the photon fluence spectrum in a volume <img class="formulaInl" alt="$V$" src="form_103.png"/> defined by the <b><code>cavity regions</code></b>.</p>
<h1><a class="anchor" id="egs_kerma_output"></a>
Output</h1>
<p>Kerma to medium in the volume of interest for each geometry as well as kerma ratios requested by the user are output to an *.egslog file (batch execution) or to the screen (interactive execution). If a fluence calculation is requested, total and differential photon fluences are also output for each calculation geometry. Additionally, a <a href="http://plasma-gate.weizmann.ac.il/Grace/">Grace</a> plot of the differential fluence for all geometries is generated in a file (*.agr).</p>
<h1><a class="anchor" id="egs_kerma_usage"></a>
Usage</h1>
<p>As any other EGSnrc application, <code>egs_kerma</code> can be started from the command line using </p>
<pre class="fragment">egs_kerma -i input_file [-p pegs_file] [-o output_file] [-b] [-s] [-P N -j i]
</pre><p> where the arguments in square brackets are optional. With the <code>-o</code> option one can change the name of the output files (by default <code>input_file.xxx</code> is used, where <code>xxx</code> is <code></code>.egslog for the log file, <code></code>.egsdat for the data file, etc.). With <code>-b</code> one specifies a "batch" run, <em>i.e</em>. the output is redirected to <code>output_file.egslog</code>. With <code>-s</code> one can force <code>egs_kerma</code> to use a simple RCO instead of a JCF-RCO in parallel runs specified with <code>-P N -j i</code>, where <code>N</code> is the number of parallel jobs and <code>i</code> the job index. Note that one Unix-type systems it is easier to use the <code>exb</code> command to submit parallel jobs </p>
<pre class="fragment">exb egs_kerma input_file pegs_file [p=N] [batch=pbs]
</pre><p> where the <code>batch</code> option specifies the queuing system to be used. If using a <em>pegsless</em> input file, then <b><code>pegs_file</code></b> must be substituted with the keyword <em>pegsless</em>. The EGSnrc GUI can be also used, see see PIRS-877 for more details on running EGSnrc applications.</p>
<h1><a class="anchor" id="egs_kerma_example"></a>
An input example: Kerma in 5 cm air sphere for 40 keV</h1>
<p>photons</p>
<pre class="fragment">###############################################################################
#
#  EGSnrc egs++ egs_kerma application sample input file
#  Copyright (C) 2016 National Research Council Canada
#
#  This file is part of EGSnrc.
#
#  EGSnrc is free software: you can redistribute it and/or modify it under
#  the terms of the GNU Affero General Public License as published by the
#  Free Software Foundation, either version 3 of the License, or (at your
#  option) any later version.
#
#  EGSnrc is distributed in the hope that it will be useful, but WITHOUT ANY
#  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
#  FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for
#  more details.
#
#  You should have received a copy of the GNU Affero General Public License
#  along with EGSnrc. If not, see &lt;http://www.gnu.org/licenses/&gt;.
#
###############################################################################
#
#  Author:        Ernesto Mainegra-Hing, 2016
#
#  Contributors:
#
###############################################################################
#
#  A simple example input file for the egs_kerma C++ application.
#
#  Simulates a 40 keV isotropic photon source in a room with concrete walls.
#  Kerma and fluence inside a 5 cm radius air sphere are calculated using a
#  forced-detection (FD) technique and a track-length estimator. The air sphere
#  is in the centre of the room and the source is 1 m from the sphere.
#
#  NOTE 1: Material data is generated in pegsless mode. If source energy
#          changed, make sure to adjust energy cut-offs (ae, ue, ap, up) below.
#
#  NOTE 2: Two geometries are used here for illustration purposes. Most likely
#          only one geometry is needed for kerma and fluence calculations.
#
###############################################################################


###############################################################################
### Geometry
###############################################################################
:start geometry definition:

    ### air cavity, spherical, 5 cm radius
    :start geometry:
        name     = cavity
        library  = egs_spheres
        midpoint = 0 0 0
        radii    = 5.0
        :start media input:
            media = air
        :stop media input:
    :stop geometry:

    ### air box (8 m x 8 m x 8 m)
    :start geometry:
        name     = air
        library  = egs_box
        box size = 800
        :start media input:
            media = air
        :stop media input:
    :stop geometry:

    ### room with 1 m thick concrete walls
    :start geometry:
        name     = walls
        library  = egs_box
        box size = 900
        :start media input:
            media = concrete
        :stop media input:
    :stop geometry:

    ### room with concrete walls
    :start geometry:
        name = room
        library = egs_genvelope
        base geometry = walls
        inscribed geometries = air
    :stop geometry:

    ###########################################################################
    #
    # The two geometries below are identical
    #
    # The purpose is to account for wall contributions to the air sphere. The
    # first geometry does NOT include contributions from the wall during the
    # calculation, while the second one does. See the 'scoring options' block
    # for more detail.
    #
    # There are several ways of accomplishing this. One could just have used
    # the same geometry for both calculations, with and without the sensitive
    # regions, or have one geometry with and another without the walls.
    #
    ###########################################################################

    ### air sphere in room with concrete walls (wall contribution NOT included)
    :start geometry:
        name    = cavity_in_room_no_wall
        library = egs_genvelope
        base geometry = room
        inscribed geometries = cavity
    :stop geometry:

    ### air sphere in room with concrete walls (wall contribution included)
    :start geometry:
        name    = cavity_in_room_all
        library = egs_genvelope
        base geometry = room
        inscribed geometries = cavity
    :stop geometry:

    ### simulation geometry
    simulation geometry = cavity_in_room_no_wall

:stop geometry definition:


###############################################################################
### Media
###############################################################################
:start media definition:

    ### energy cutoffs
    ae = 0.512
    ue = 0.555
    ap = 0.001
    up = 0.045

    ### air
    :start air:
        density correction file = air_dry_nearsealevel
    :stop air:

    ### concrete
    :start concrete:
        density correction file = concrete_ordinary
    :stop concrete:

:stop media definition:


###############################################################################
### Source
###############################################################################
:start source definition:

    ### isotropic
    :start source:
        name    = isotropic
        library = egs_isotropic_source
        charge  = 0

        ### source shape
        :start shape:
            type = point
            position = 0, 0, -100
        :stop shape:

        ### source spectrum
        :start spectrum:
            type = monoenergetic
            energy = 0.04  # MeV
        :stop spectrum:

   :stop source:

   ### simulation source
   simulation source = isotropic

:stop source definition:


###############################################################################
### Scoring options
###############################################################################
:start scoring options:

    ### use the same geometry under two different names, for easier bookeeping
    :start calculation geometry:
        geometry name    = cavity_in_room_no_wall
        cavity regions   = 2
        excluded regions = 0  # exclude particles passing through these regions
        cavity mass      = 0.630831804841  # 5 cm radius air sphere
    :stop calculation geometry:

    :start calculation geometry:
        geometry name     = cavity_in_room_all
        cavity regions    = 2
        #excluded regions = 0  # exclude particles passing through these regions
        cavity mass       = 0.630831804841  # 5 cm radius air sphere
    :stop calculation geometry:

    ### ratio estimates wall contribution to air sphere
    correlated geometries = cavity_in_room_all  cavity_in_room_no_wall

    ### fluence scoring requested (common to all calculation geometries)
    :start fluence scoring:
        minimum energy = 0.0
        maximum energy = 0.040
        number of bins = 400
        scale          = linear
    :stop fluence scoring:

    ### E*muen file (could also be E*mutr): absolute or relative file path
    emuen file = emuen_icru90_1.5MeV.data

    ### geometry for forced-detection (if omitted, an analog scoring is used)
    cavity geometry = cavity

:stop scoring options:


###############################################################################
### Transport parameters
###############################################################################
:start MC transport parameter:

    ### you can include here any of the EGSnrc transport parameters

    Global ECUT = 2000.                 # Turn-off electron transport
    Photon cross sections = mcdf-xcom   # XCOM with renormalized PE xsections

:stop MC transport parameter:


###############################################################################
### Run control
###############################################################################
:start run control:
    ncase = 1000000
:stop run control:
</pre> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
